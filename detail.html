<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Kawasan - SIS KEHATI</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding-bottom: 60px; }
        .hero-header { position: relative; background-size: cover; background-position: center; height: 350px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 30px; border-bottom: 5px solid #2c7a3f; }
        .hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .hero-content { position: relative; z-index: 2; text-align: center; }
        .btn-back { background: white; color: #333; font-weight: bold; padding: 8px 20px; border-radius: 50px; text-decoration: none; margin-top: 15px; display: inline-block; }
        
        .stat-box { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; height: 100%; border-top: 4px solid #ddd; }
        .val-num { font-size: 2.2rem; font-weight: 800; margin: 5px 0; color: #333; }
        .border-green { border-top-color: #2e7d32; } 
        
        .card-custom { border: none; border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; height: 100%; }
        .card-header-custom { background: #fff; border-bottom: 1px solid #f0f0f0; padding: 15px 20px; font-weight: 700; color: #444; }
        
        .fixed-box { height: 350px; width: 100%; }
        #miniMap { height: 100%; width: 100%; z-index: 1; }
        .species-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-right: 15px; border: 2px solid #eee; }
        
        /* Flagship Box */
        .flagship-box { background: linear-gradient(135deg, #fffde7 0%, #fff 100%); border: 2px solid #fbc02d; }
        .flagship-img { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; border: 3px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .section-title { border-left: 5px solid #2c7a3f; padding-left: 15px; margin: 30px 0 20px 0; font-weight: 800; color: #2c7a3f; text-transform: uppercase; }
    </style>
</head>
<body>

    <!-- HERO HEADER -->
    <div class="hero-header" id="dynamicHeader">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="display-5 fw-bold" id="locName">Loading...</h1>
            <p class="lead mb-0" id="locDesc">...</p>
            <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali ke Peta</a>
        </div>
    </div>

    <div class="container" style="margin-top: -60px; position: relative; z-index: 10;">

        <!-- 1. INDEKS FLORA SAAT INI -->
        <div class="row mb-4">
            <div class="col-12 text-center mb-2"><span class="badge bg-success px-3 py-2">DATA VEGETASI (POHON)</span></div>
            <div class="col-md-4 mb-2"><div class="stat-box border-green"><small class="fw-bold text-muted">Keanekaragaman (H')</small><div class="val-num text-success" id="valH">-</div><small id="catH">-</small></div></div>
            <div class="col-md-4 mb-2"><div class="stat-box border-green"><small class="fw-bold text-muted">Kemerataan (E)</small><div class="val-num text-success" id="valE">-</div><small>Tinggi/Merata</small></div></div>
            <div class="col-md-4 mb-2"><div class="stat-box border-green"><small class="fw-bold text-muted">Kekayaan (R)</small><div class="val-num text-success" id="valR">-</div><small>Kekayaan Tinggi</small></div></div>
        </div>

        <!-- 2. PETA AREA & GRAFIK (3 KOLOM) -->
        <div class="row">
            <div class="col-12 mb-3"><div class="card card-custom"><div class="card-header-custom"><i class="fas fa-map-marked-alt text-success me-2"></i> Area Delineasi Pantau</div><div class="card-body p-0"><div style="height: 300px;" id="miniMap"></div></div></div></div>
            
            <!-- 3 GRAFIK BERBEDA WARNA -->
            <div class="col-md-4 mb-3"><div class="card card-custom"><div class="card-body"><h6 class="text-center fw-bold text-success">Tren Indeks H' (Hijau)</h6><canvas id="chartH"></canvas></div></div></div>
            <div class="col-md-4 mb-3"><div class="card card-custom"><div class="card-body"><h6 class="text-center fw-bold text-primary">Tren Indeks E (Biru)</h6><canvas id="chartE"></canvas></div></div></div>
            <div class="col-md-4 mb-3"><div class="card card-custom"><div class="card-body"><h6 class="text-center fw-bold text-warning">Tren Indeks R (Oranye)</h6><canvas id="chartR"></canvas></div></div></div>
        </div>

        <h4 class="section-title">Detail Data Monitoring Flora & Fauna</h4>

        <!-- 3. FLORA & BURUNG (GRAFIK SPESIES) -->
        <div class="row">
            <!-- Flora -->
            <div class="col-lg-6 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header-custom"><i class="fas fa-leaf text-success me-2"></i> Statistik Flora</div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6"><div class="bg-light p-2 rounded"><h3 class="fw-bold text-success mb-0" id="floraTotal">-</h3><small>Jenis</small></div></div>
                            <div class="col-6"><div class="bg-light p-2 rounded"><h3 class="fw-bold text-success mb-0" id="floraFam">-</h3><small>Famili</small></div></div>
                        </div>
                        <h6 class="small fw-bold text-secondary">Tren Jumlah Spesies (2020-2025)</h6>
                        <div style="height: 200px;"><canvas id="floraSpeciesChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Burung -->
            <div class="col-lg-6 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header-custom"><i class="fas fa-dove text-info me-2"></i> Statistik Avifauna</div>
                    <div class="card-body">
                         <div class="row text-center mb-3">
                            <div class="col-6"><div class="bg-light p-2 rounded"><h3 class="fw-bold text-info mb-0" id="birdSpecies">-</h3><small>Spesies</small></div></div>
                            <div class="col-6"><div class="bg-light p-2 rounded"><h3 class="fw-bold text-secondary mb-0" id="birdFamily">-</h3><small>Famili</small></div></div>
                        </div>
                        <h6 class="small fw-bold text-secondary">Tren Jumlah Spesies Burung</h6>
                        <div style="height: 200px;"><canvas id="birdTrendChart"></canvas></div>
                        <div class="mt-3 small">
                             <b>Dominasi:</b> <span id="birdDom">-</span><br>
                             <b>Spesies Kunci:</b> <span id="birdKey">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. FLAGSHIP & RED LIST -->
        <div class="row">
            <div class="col-lg-5 mb-4" id="flagshipSection">
                <div class="card card-custom flagship-box h-100">
                    <div class="card-body text-center">
                        <img src="" class="flagship-img mb-3" id="flagImg" alt="Flagship" onerror="this.src='https://via.placeholder.com/400x300'">
                        <h5 class="fw-bold mb-1"><i class="fas fa-crown text-warning"></i> FLAGSHIP SPECIES</h5>
                        <h4 class="fw-bold text-danger" id="flagName">-</h4>
                        <p class="small text-muted" id="flagDesc">-</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header-custom"><i class="fas fa-shield-alt text-danger me-2"></i> Daftar Spesies Dilindungi</div>
                    <div class="card-body">
                        <div id="protectedList"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script src="database.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        Chart.register(ChartDataLabels);
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id') || 'kehati_aqua';
        const data = db_kehati.locations[id];

        if(data) {
            // Header Image
            const headerUrl = data.headerImage ? data.headerImage : 'https://images.unsplash.com/photo-1511497584788-876760111969';
            document.getElementById('dynamicHeader').style.backgroundImage = `url('${headerUrl}')`;

            document.getElementById('locName').innerText = data.name;
            document.getElementById('locDesc').innerText = data.desc;
            document.getElementById('valH').innerText = data.indices?.H;
            document.getElementById('catH').innerText = data.indices?.cat;
            document.getElementById('valE').innerText = data.indices?.E;
            document.getElementById('valR').innerText = data.indices?.R;

            document.getElementById('floraTotal').innerText = data.floraStats?.total;
            document.getElementById('floraFam').innerText = data.floraStats?.famili;
            document.getElementById('birdSpecies').innerText = data.birdStats?.species;
            document.getElementById('birdFamily').innerText = data.birdStats?.family;
            document.getElementById('birdDom').innerText = data.birdStats?.dom;
            document.getElementById('birdKey').innerText = data.birdStats?.key;

            // Flagship Species
            if(data.flagshipSpecies) {
                document.getElementById('flagName').innerText = data.flagshipSpecies.name;
                document.getElementById('flagDesc').innerText = data.flagshipSpecies.desc;
                document.getElementById('flagImg').src = data.flagshipSpecies.img;
            } else {
                document.getElementById('flagshipSection').innerHTML = `<div class="card card-custom h-100 p-4 text-center text-muted">Tidak ada Flagship Species.</div>`;
            }

            // Protected List (Foto Besar)
            const listContainer = document.getElementById('protectedList');
            if(data.protectedList?.length > 0) {
                data.protectedList.forEach(item => {
                    let imgUrl = item.img ? item.img : 'https://via.placeholder.com/80';
                    let badge = item.status.includes('Dilindungi') ? 'bg-danger' : 'bg-warning text-dark';
                    listContainer.innerHTML += `
                        <div class="d-flex align-items-center mb-3 border-bottom pb-2">
                            <img src="${imgUrl}" class="species-thumb" onerror="this.src='https://via.placeholder.com/80'">
                            <div>
                                <div class="fw-bold">${item.name}</div>
                                <span class="badge ${badge} badge-status">${item.status}</span>
                            </div>
                        </div>`;
                });
            }

            // PETA
            const map = L.map('miniMap', { zoomControl: false }).setView([data.lat, data.lng], 15);
            L.tileLayer('http://mt0.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);
            if(data.detailPolygon) {
                // Polygon sudah fix (Lat, Lng)
                data.detailPolygon.forEach(polyCoords => {
                    L.polygon(polyCoords, { color: '#ffd700', fillColor: '#ffd700', fillOpacity: 0.3, weight: 2 }).addTo(map);
                });
            } else { L.marker([data.lat, data.lng]).addTo(map); }

            // FUNGSI BUAT GRAFIK
            function createChart(ctxId, label, dataValues, color) {
                new Chart(document.getElementById(ctxId).getContext('2d'), {
                    type: 'bar',
                    data: { 
                        labels: data.floraStats.years, // Pakai tahun yang sama
                        datasets: [{ label: label, data: dataValues, backgroundColor: color, borderRadius: 4 }] 
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { legend: {display:false}, datalabels: { anchor:'end', align:'top', font:{weight:'bold'} } },
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }

            // 3 GRAFIK POHON (H, E, R)
            if(data.historyH) createChart('chartH', "Indeks H'", data.historyH, '#4caf50'); // Hijau
            if(data.historyE) createChart('chartE', "Indeks E", data.historyE, '#2196f3'); // Biru
            if(data.historyR) createChart('chartR', "Indeks R", data.historyR, '#ff9800'); // Oranye

            // GRAFIK SPESIES FLORA
            if(data.floraStats?.values) createChart('floraSpeciesChart', "Jml Spesies", data.floraStats.values, '#b2ff59'); // Hijau Muda

            // GRAFIK SPESIES BURUNG
            if(data.birdTrend) createChart('birdTrendChart', "Jml Burung", data.birdTrend, '#81d4fa'); // Biru Muda
        }
    </script>
</body>
</html>
