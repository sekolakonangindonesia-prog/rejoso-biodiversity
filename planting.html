<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Penanaman - SIS KEHATI</title>
    
    <!-- Library CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Library JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f0f2f5; padding-bottom: 50px; }
        .hero-header { position: relative; background: #1b5e20; height: 280px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 30px; border-bottom: 5px solid #2e7d32; }
        .hero-content { position: relative; z-index: 2; text-align: center; }
        .btn-home { background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 50px; padding: 8px 20px; text-decoration: none; display:inline-block; margin-top:10px; transition:0.3s; }
        .btn-home:hover { background: white; color: #1b5e20; }
        
        .stat-card { color: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 140px; position:relative; overflow:hidden;}
        .stat-val { font-size: 2.8rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .bg-tree { background: #2e7d32; } .bg-rorak { background: #5d4037; } .bg-sumur { background: #0277bd; }
        
        .card-custom { border: none; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; height: 100%; }
        .card-header-custom { background: white; padding: 15px; border-bottom: 1px solid #eee; font-weight: 700; color: #333; }
        
        #map { height: 450px; width: 100%; z-index: 1; border-radius: 0 0 8px 8px; }
        .chart-wrapper { position: relative; width: 100%; height: 300px; }
        
        /* Styles untuk Tabel Replenished */
        .replenish-box { background-color: #fff3e0; border: 1px solid #ffe0b2; padding: 8px; border-radius: 6px; margin-top: 5px; font-size: 0.85rem; }
        .replenish-val { font-weight: 800; color: #e65100; }
        .replenish-label { color: #666; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }

        .table-hover tbody tr:hover { background-color: #e8f5e9; cursor: pointer; transform: scale(1.002); transition:0.2s; }
    </style>
</head>
<body>

    <div class="hero-header">
        <div class="hero-content">
            <img src="logo-sk.png" style="height: 50px; margin-bottom: 10px;" onerror="this.style.display='none'">
            <h2 class="fw-bold mb-0 text-uppercase">Monitoring Penanaman</h2>
            <p class="mb-0 opacity-75">Sistem Informasi Sebaran Penanaman & Sipil Teknis</p>
            <a href="index.html" class="btn-home"><i class="fas fa-arrow-left me-2"></i>Dashboard Utama</a>
        </div>
    </div>

    <div class="container-fluid px-4" style="margin-top: -50px; position: relative; z-index: 10;">
        
        <!-- ROW 1: TOP STATS -->
        <div class="row mb-4">
            <div class="col-md-4 mb-2"><div class="stat-card bg-tree"><div class="stat-header">Total Pohon</div><div class="stat-val" id="totalTrees">Loading...</div><small>Akumulasi 2021-2025</small><i class="fas fa-tree position-absolute end-0 bottom-0 m-3 opacity-25 fa-3x"></i></div></div>
            <div class="col-md-4 mb-2"><div class="stat-card bg-rorak"><div class="stat-header">Total Rorak</div><div class="stat-val" id="totalRorak">Loading...</div><small>Unit Sipil Teknis</small><i class="fas fa-inbox position-absolute end-0 bottom-0 m-3 opacity-25 fa-3x"></i></div></div>
            <div class="col-md-4 mb-2"><div class="stat-card bg-sumur"><div class="stat-header">Total Resapan Air</div><div class="stat-val" id="totalReplenish">Loading...</div><small>ML/Year (Estimasi Infiltrasi)</small><i class="fas fa-water position-absolute end-0 bottom-0 m-3 opacity-25 fa-3x"></i></div></div>
        </div>

        <!-- ROW 2: PETA & CHART KECIL -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-3">
                <div class="card card-custom h-100">
                    <div class="card-header-custom d-flex justify-content-between"><span><i class="fas fa-map-marked-alt text-success me-2"></i> Peta Sebaran</span><span class="badge bg-warning text-dark">2021 - 2024</span></div>
                    <div class="card-body p-0"><div id="map"></div></div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card card-custom mb-3" style="height: auto;">
                    <div class="card-header-custom"><i class="fas fa-chart-bar text-success me-2"></i> Realisasi Pohon</div>
                    <div class="card-body"><div class="chart-wrapper" style="height: 200px;"><canvas id="barChart"></canvas></div></div>
                </div>
                <div class="card card-custom" style="height: auto;">
                    <div class="card-header-custom"><i class="fas fa-chart-pie text-success me-2"></i> Komposisi Tanaman</div>
                    <div class="card-body"><div class="chart-wrapper" style="height: 200px;"><canvas id="pieChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <!-- ROW 3: GRAFIK SIPIL TEKNIS -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card card-custom"><div class="card-header-custom"><i class="fas fa-inbox text-warning me-2" style="color:#5d4037!important"></i> Pembuatan Rorak (Unit)</div><div class="card-body"><div class="chart-wrapper"><canvas id="chartRorak"></canvas></div></div></div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card card-custom"><div class="card-header-custom"><i class="fas fa-water text-primary me-2"></i> Sumur Resapan & Biopori (Unit)</div><div class="card-body"><div class="chart-wrapper"><canvas id="chartSumur"></canvas></div></div></div>
            </div>
        </div>

        <!-- ROW 4: POSITIVE WATER IMPACT (CHART BAR GANDA) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom border-primary">
                    <div class="card-header-custom bg-light text-primary border-bottom border-primary"><i class="fas fa-balance-scale text-primary me-2"></i> POSITIVE WATER IMPACT (REPLENISHED WATER)</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <h6 class="text-center fw-bold text-secondary mb-3">Balance (L/s) vs Performance (%)</h6>
                                <div class="chart-wrapper" style="height: 400px;"><canvas id="wbChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 5: TABEL HISTORY -->
        <div class="card card-custom mb-5">
            <div class="card-header-custom"><i class="fas fa-list text-dark me-2"></i> Riwayat Program Tahunan & Dampak Air</div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Tahun</th>
                            <th>Program / Lokasi</th>
                            <th class="text-center">Pohon</th>
                            <th class="text-center">Rorak</th>
                            <th class="text-center">Sumur</th>
                            <th class="text-center">Biopori</th>
                            <th class="text-end pe-4" style="min-width: 180px;">Replenished Water</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SCRIPT & DATA -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. DATA PETA (KOORDINAT MASTER LENGKAP) ---
        // Saya kembalikan koordinat lengkap dari data awal Anda agar peta tidak berantakan/putus-putus
        const MASTER_DESA_GALIH = [
            [-7.808762, 112.896381], [-7.809949, 112.896231], [-7.810725, 112.896394], [-7.812848, 112.895910],
            [-7.813272, 112.897058], [-7.813911, 112.897229], [-7.815008, 112.897272], [-7.815752, 112.897711],
            [-7.816275, 112.897639], [-7.818646, 112.899821], [-7.818396, 112.900724], [-7.819161, 112.900734],
            [-7.819707, 112.900403], [-7.820462, 112.901146], [-7.820489, 112.901897], [-7.820361, 112.902680],
            [-7.821101, 112.902778], [-7.821795, 112.902688], [-7.822534, 112.902490], [-7.823555, 112.903113],
            [-7.823933, 112.903573], [-7.824078, 112.904661], [-7.824179, 112.905970], [-7.823780, 112.906853],
            [-7.823796, 112.907674], [-7.823195, 112.909083], [-7.823130, 112.910525], [-7.824248, 112.911659],
            [-7.825552, 112.912372], [-7.825921, 112.912869], [-7.826685, 112.913142], [-7.827294, 112.913384],
            [-7.827611, 112.914082], [-7.827434, 112.914600], [-7.828445, 112.914744], [-7.829121, 112.915242],
            [-7.829724, 112.919683], [-7.829774, 112.920048], [-7.828535, 112.919647], [-7.828432, 112.919558],
            [-7.828413, 112.919540], [-7.828376, 112.919520], [-7.828316, 112.919488], [-7.828194, 112.919422],
            [-7.828133, 112.919390], [-7.828103, 112.919374], [-7.828065, 112.919353], [-7.827964, 112.919298],
            [-7.827860, 112.919175], [-7.827761, 112.919055], [-7.827665, 112.918939], [-7.827595, 112.918857],
            [-7.827528, 112.918771], [-7.827393, 112.918597], [-7.827041, 112.918547], [-7.826591, 112.918336],
            [-7.826183, 112.917986], [-7.825943, 112.917729], [-7.825852, 112.917630], [-7.825464, 112.917424],
            [-7.825083, 112.917494], [-7.824928, 112.917500], [-7.824777, 112.917500], [-7.824723, 112.917558],
            [-7.824659, 112.917623], [-7.824439, 112.917533], [-7.824390, 112.917512], [-7.824340, 112.917496],
            [-7.824205, 112.917452], [-7.823483, 112.917647], [-7.823249, 112.917706], [-7.822929, 112.917587],
            [-7.822795, 112.917539], [-7.822667, 112.917531], [-7.822351, 112.917505], [-7.822225, 112.917498],
            [-7.821987, 112.917575], [-7.821948, 112.917591], [-7.821904, 112.917623], [-7.821843, 112.917672],
            [-7.821784, 112.917713], [-7.821526, 112.917771], [-7.821479, 112.917785], [-7.821425, 112.917786],
            [-7.821264, 112.917789], [-7.821150, 112.917809], [-7.820990, 112.917791], [-7.820848, 112.917715],
            [-7.820688, 112.917685], [-7.820492, 112.917726], [-7.820278, 112.917746], [-7.820152, 112.917726],
            [-7.820028, 112.917807], [-7.819710, 112.917641], [-7.819483, 112.917595], [-7.819357, 112.917528],
            [-7.819274, 112.917400], [-7.819244, 112.917358], [-7.819209, 112.917315], [-7.819124, 112.917244],
            [-7.819010, 112.917221], [-7.818961, 112.917216], [-7.818911, 112.917220], [-7.818677, 112.917215],
            [-7.818534, 112.917259], [-7.818393, 112.917344], [-7.818179, 112.917383], [-7.818092, 112.917405],
            [-7.817989, 112.917451], [-7.817897, 112.917472], [-7.817808, 112.917491], [-7.817620, 112.917523],
            [-7.817452, 112.917573], [-7.817372, 112.917596], [-7.817282, 112.917619], [-7.817077, 112.917625],
            [-7.816700, 112.917523], [-7.816548, 112.917459], [-7.816186, 112.917477], [-7.815800, 112.917534],
            [-7.815418, 112.917572], [-7.815258, 112.917558], [-7.815132, 112.917608], [-7.814986, 112.917583],
            [-7.814910, 112.917572], [-7.814757, 112.917502], [-7.814695, 112.917488], [-7.814662, 112.917499],
            [-7.814631, 112.917508], [-7.814394, 112.917585], [-7.814242, 112.917655], [-7.814118, 112.917759],
            [-7.813776, 112.917912], [-7.813694, 112.917952], [-7.813573, 112.918121], [-7.813405, 112.918391],
            [-7.813340, 112.918544], [-7.813212, 112.918659], [-7.813115, 112.918737], [-7.812890, 112.918850],
            [-7.812689, 112.919122], [-7.812583, 112.919256], [-7.812437, 112.919401], [-7.812344, 112.919417],
            [-7.812244, 112.919433], [-7.811920, 112.919307], [-7.811751, 112.919253], [-7.811595, 112.919180],
            [-7.811349, 112.919058], [-7.811136, 112.918912], [-7.810857, 112.918829], [-7.810748, 112.918798],
            [-7.810653, 112.918808], [-7.810541, 112.918828], [-7.810421, 112.918850], [-7.810367, 112.918867],
            [-7.810312, 112.918855], [-7.810149, 112.918800], [-7.810059, 112.918749], [-7.809892, 112.918654],
            [-7.809798, 112.918613], [-7.809712, 112.918593], [-7.809357, 112.918530], [-7.809066, 112.918619],
            [-7.808757, 112.918622], [-7.808157, 112.918572], [-7.808099, 112.918568], [-7.808047, 112.918585],
            [-7.807910, 112.918646], [-7.807648, 112.918748], [-7.807142, 112.918960], [-7.806919, 112.919074],
            [-7.806808, 112.919146], [-7.806667, 112.919230], [-7.806556, 112.919306], [-7.806435, 112.919367],
            [-7.806300, 112.919427], [-7.806162, 112.919451], [-7.805938, 112.919476], [-7.805708, 112.919484],
            [-7.805567, 112.919482], [-7.805260, 112.919370], [-7.804508, 112.919152], [-7.804080, 112.919080],
            [-7.803473, 112.919151], [-7.803074, 112.919166], [-7.802736, 112.919274], [-7.801967, 112.919551],
            [-7.801602, 112.919579], [-7.801448, 112.919584], [-7.801239, 112.919550], [-7.801069, 112.919463],
            [-7.800903, 112.919401], [-7.800460, 112.919272], [-7.799433, 112.918981], [-7.799337, 112.918953],
            [-7.799281, 112.918987], [-7.799133, 112.919068], [-7.799017, 112.919121], [-7.798747, 112.919251],
            [-7.798480, 112.919371], [-7.798124, 112.919422], [-7.797709, 112.919479], [-7.797230, 112.919586],
            [-7.796923, 112.919667], [-7.796681, 112.919582], [-7.796557, 112.919540], [-7.796498, 112.919517],
            [-7.796444, 112.919484], [-7.796265, 112.919369], [-7.796172, 112.919311], [-7.796095, 112.919241],
            [-7.795856, 112.918999], [-7.795734, 112.918876], [-7.795607, 112.918751], [-7.795506, 112.918651],
            [-7.795409, 112.918546], [-7.795195, 112.918327], [-7.794935, 112.918056], [-7.794721, 112.917835],
            [-7.794509, 112.917613], [-7.794385, 112.917485], [-7.794251, 112.917396], [-7.793982, 112.917221],
            [-7.793774, 112.917084], [-7.793438, 112.917008], [-7.793132, 112.916948], [-7.792824, 112.916890],
            [-7.792633, 112.916853], [-7.792508, 112.916888], [-7.792286, 112.916940], [-7.792271, 112.916529],
            [-7.792327, 112.915885], [-7.792430, 112.915241], [-7.792513, 112.914834], [-7.792806, 112.914164],
            [-7.793244, 112.912589], [-7.793133, 112.910419], [-7.792862, 112.908891], [-7.792546, 112.907823],
            [-7.791499, 112.907447], [-7.790597, 112.907332], [-7.789350, 112.907732], [-7.788072, 112.907674],
            [-7.787715, 112.907215], [-7.787841, 112.906806], [-7.787661, 112.905639], [-7.788452, 112.898582],
            [-7.789726, 112.896976], [-7.790645, 112.896544], [-7.791369, 112.896043], [-7.792515, 112.895868],
            [-7.793827, 112.895279], [-7.794788, 112.895187], [-7.796051, 112.895214], [-7.797249, 112.895203],
            [-7.798318, 112.895220], [-7.799194, 112.895661], [-7.800123, 112.895726], [-7.800920, 112.895667],
            [-7.801298, 112.895249], [-7.802147, 112.894652], [-7.802471, 112.894794], [-7.802755, 112.895035],
            [-7.803399, 112.895195], [-7.804655, 112.895078], [-7.805747, 112.895103], [-7.807085, 112.895810],
            [-7.807522, 112.895894], [-7.808761, 112.895559], [-7.808762, 112.896381]
        ];

        const MASTER_HUTAN_LINDUNG = [
            [-7.804688, 112.906485], [-7.805071, 112.906485], [-7.805539, 112.906528], [-7.805730, 112.906378],
            [-7.805666, 112.906270], [-7.805964, 112.906270], [-7.806219, 112.906227], [-7.806431, 112.905970],
            [-7.806389, 112.906013], [-7.807112, 112.905755], [-7.806857, 112.905884], [-7.806644, 112.906013],
            [-7.806431, 112.906099], [-7.807027, 112.905863], [-7.807218, 112.905691], [-7.807324, 112.905755],
            [-7.807409, 112.905669], [-7.807494, 112.905627], [-7.807962, 112.905669], [-7.808260, 112.905755],
            [-7.808982, 112.905455], [-7.808982, 112.905433], [-7.809238, 112.905541], [-7.809514, 112.905498],
            [-7.809897, 112.905476], [-7.809323, 112.905498], [-7.809556, 112.905455], [-7.809641, 112.905562],
            [-7.809280, 112.905498], [-7.809152, 112.905455], [-7.809365, 112.905519], [-7.809216, 112.905305],
            [-7.809386, 112.905412], [-7.809769, 112.905412], [-7.810130, 112.905412], [-7.810513, 112.905412],
            [-7.810789, 112.905691], [-7.811108, 112.906142], [-7.811130, 112.906292], [-7.811300, 112.906313],
            [-7.811215, 112.906528], [-7.811172, 112.906699], [-7.811300, 112.906850], [-7.811066, 112.906871],
            [-7.810959, 112.907064], [-7.810683, 112.907558], [-7.809726, 112.908395], [-7.809004, 112.909274],
            [-7.808345, 112.909982], [-7.807090, 112.909510], [-7.805772, 112.908974], [-7.803583, 112.908416],
            [-7.802775, 112.908566], [-7.802010, 112.908588], [-7.802095, 112.908287], [-7.802371, 112.907708],
            [-7.802435, 112.907386], [-7.802498, 112.907193], [-7.802318, 112.907118], [-7.802180, 112.906914],
            [-7.802413, 112.906699], [-7.803115, 112.906506], [-7.803200, 112.906485], [-7.803328, 112.906528],
            [-7.803668, 112.906313], [-7.803923, 112.906227], [-7.804305, 112.906399], [-7.804688, 112.906485]
        ];

        const MASTER_PETUNG = [
            [-7.796914, 112.919663], [-7.797714, 112.919479], [-7.798473, 112.919373], [-7.798972, 112.919149],
            [-7.799335, 112.918953], [-7.800971, 112.919417], [-7.801221, 112.919538], [-7.801476, 112.919587],
            [-7.801947, 112.919557], [-7.802550, 112.919333], [-7.803031, 112.919182], [-7.803634, 112.919162],
            [-7.804106, 112.919072], [-7.804672, 112.919183], [-7.805290, 112.919377], [-7.805566, 112.919481],
            [-7.805921, 112.919479], [-7.806273, 112.919438], [-7.806556, 112.919309], [-7.807004, 112.919015],
            [-7.808091, 112.918568], [-7.808674, 112.918621], [-7.809053, 112.918619], [-7.809347, 112.918523],
            [-7.809793, 112.918603], [-7.810145, 112.918798], [-7.810358, 112.918865], [-7.810559, 112.918819],
            [-7.810750, 112.918797], [-7.810894, 112.918836], [-7.811133, 112.918912], [-7.811351, 112.919059],
            [-7.811691, 112.919227], [-7.812056, 112.919354], [-7.812242, 112.919435], [-7.812440, 112.919399],
            [-7.812625, 112.919209], [-7.812884, 112.918850], [-7.813134, 112.918722], [-7.813328, 112.918553],
            [-7.813415, 112.918354], [-7.813691, 112.917952], [-7.814118, 112.917759], [-7.814240, 112.917658],
            [-7.814388, 112.917587], [-7.814628, 112.917509], [-7.814694, 112.917488], [-7.814772, 112.917507],
            [-7.814903, 112.917569], [-7.815128, 112.917606], [-7.815253, 112.917557], [-7.815405, 112.917571],
            [-7.815704, 112.917542], [-7.816216, 112.917475], [-7.816534, 112.917452], [-7.816769, 112.917534],
            [-7.817074, 112.917624], [-7.817245, 112.917628], [-7.817411, 112.917584], [-7.817590, 112.917528],
            [-7.817850, 112.917483], [-7.817984, 112.917450], [-7.818143, 112.917390], [-7.818389, 112.917346],
            [-7.818538, 112.917258], [-7.818682, 112.917214], [-7.818983, 112.917217], [-7.819126, 112.917244],
            [-7.819231, 112.917336], [-7.819329, 112.917483], [-7.819392, 112.917544], [-7.819465, 112.917592],
            [-7.819703, 112.917641], [-7.820021, 112.917802], [-7.820145, 112.917733], [-7.820210, 112.917735],
            [-7.820277, 112.917746], [-7.820400, 112.917726], [-7.820502, 112.917721], [-7.820682, 112.917681],
            [-7.820844, 112.917709], [-7.820990, 112.917790], [-7.821149, 112.917808], [-7.821267, 112.917788],
            [-7.821464, 112.917787], [-7.821612, 112.917751], [-7.821788, 112.917710], [-7.821955, 112.917587],
            [-7.822231, 112.917496], [-7.822795, 112.917538], [-7.823247, 112.917706], [-7.824206, 112.917451],
            [-7.824391, 112.917512], [-7.824658, 112.917623], [-7.824777, 112.917501], [-7.825082, 112.917495],
            [-7.825460, 112.917423], [-7.825848, 112.917625], [-7.826166, 112.917971], [-7.826587, 112.918332],
            [-7.827044, 112.918548], [-7.827393, 112.918595], [-7.827596, 112.918858], [-7.827962, 112.919297],
            [-7.828411, 112.919538], [-7.828847, 112.919916], [-7.829622, 112.920887], [-7.829436, 112.922094],
            [-7.829514, 112.922454], [-7.829491, 112.922727], [-7.829389, 112.923354], [-7.829246, 112.924479],
            [-7.828884, 112.926453], [-7.828586, 112.927328], [-7.828414, 112.927775], [-7.828083, 112.928694],
            [-7.827810, 112.929753], [-7.827647, 112.930261], [-7.827504, 112.930627], [-7.827291, 112.931113],
            [-7.827284, 112.931321], [-7.827288, 112.931560], [-7.827291, 112.931858], [-7.827284, 112.932148],
            [-7.827259, 112.933403], [-7.827406, 112.934486], [-7.827424, 112.934596], [-7.827424, 112.934671],
            [-7.827429, 112.934862], [-7.827437, 112.935081], [-7.827440, 112.935197], [-7.827444, 112.935299],
            [-7.827456, 112.935495], [-7.827432, 112.935706], [-7.827387, 112.935945], [-7.827362, 112.936159],
            [-7.827355, 112.936221], [-7.827347, 112.936274], [-7.827313, 112.936484], [-7.827277, 112.936696],
            [-7.827240, 112.936905], [-7.827109, 112.937147], [-7.827046, 112.937365], [-7.826915, 112.937344],
            [-7.826699, 112.937294], [-7.826497, 112.937245], [-7.826359, 112.937189], [-7.826223, 112.937160],
            [-7.826067, 112.936973], [-7.825922, 112.936760], [-7.825721, 112.936556], [-7.824473, 112.936202],
            [-7.823816, 112.936135], [-7.822422, 112.935926], [-7.821125, 112.935331], [-7.820555, 112.935382],
            [-7.820142, 112.935495], [-7.819798, 112.935741], [-7.819580, 112.935989], [-7.819173, 112.935895],
            [-7.818673, 112.935711], [-7.818305, 112.935755], [-7.817943, 112.935891], [-7.817541, 112.935848],
            [-7.816874, 112.935461], [-7.815550, 112.934849], [-7.814764, 112.934505], [-7.813814, 112.934379],
            [-7.812598, 112.934145], [-7.810570, 112.933965], [-7.809489, 112.934184], [-7.807909, 112.934547],
            [-7.806408, 112.934564], [-7.805737, 112.934772], [-7.804795, 112.935598], [-7.803789, 112.935324],
            [-7.803192, 112.935287], [-7.802172, 112.935870], [-7.801021, 112.935521], [-7.800043, 112.935780],
            [-7.799307, 112.935640], [-7.798808, 112.935522], [-7.797865, 112.935338], [-7.796820, 112.934946],
            [-7.796267, 112.934272], [-7.795532, 112.934125], [-7.794864, 112.933069], [-7.794896, 112.932045],
            [-7.794489, 112.931746], [-7.793586, 112.931982], [-7.793510, 112.931545], [-7.793202, 112.930642],
            [-7.792880, 112.930522], [-7.792371, 112.930755], [-7.791249, 112.930842], [-7.790806, 112.931157],
            [-7.789550, 112.931263], [-7.788581, 112.931947], [-7.786136, 112.933870], [-7.785245, 112.933920],
            [-7.784061, 112.934598], [-7.782732, 112.934763], [-7.781894, 112.934225], [-7.781402, 112.933933],
            [-7.780761, 112.933728], [-7.780420, 112.934090], [-7.780153, 112.923638], [-7.780132, 112.921933],
            [-7.777995, 112.921008], [-7.777656, 112.920664], [-7.777560, 112.920252], [-7.777596, 112.919576],
            [-7.777495, 112.919307], [-7.777329, 112.919059], [-7.777063, 112.918702], [-7.777014, 112.918092],
            [-7.776446, 112.916364], [-7.776426, 112.914567], [-7.776211, 112.913816], [-7.776012, 112.913170],
            [-7.778111, 112.912734], [-7.778752, 112.913294], [-7.779409, 112.913824], [-7.779588, 112.913928],
            [-7.779663, 112.914042], [-7.779666, 112.914422], [-7.779977, 112.915403], [-7.780988, 112.916320],
            [-7.781197, 112.916585], [-7.781513, 112.916755], [-7.781888, 112.916864], [-7.782284, 112.916968],
            [-7.783083, 112.917021], [-7.783809, 112.916871], [-7.785225, 112.916404], [-7.787328, 112.916398],
            [-7.788040, 112.917301], [-7.789446, 112.918222], [-7.790695, 112.916773], [-7.791421, 112.916791],
            [-7.791831, 112.916885], [-7.792232, 112.916956], [-7.792639, 112.916854], [-7.793248, 112.916967],
            [-7.793770, 112.917083], [-7.794375, 112.917476], [-7.795551, 112.918696], [-7.796152, 112.919295],
            [-7.796494, 112.919515], [-7.796914, 112.919663]
        ];

        // Polygon Delineasi 2024 (Data Baru warna warni)
        const DATA_2024_POLYGONS = [
            { name: "Hutan Lestari Supinto", color: "#006064", coords: [[-7.81659, 112.90507], [-7.81652, 112.90519], [-7.81659, 112.90507]] },
            { name: "Hutan lestari Karji", color: "#e65100", coords: [[-7.81367, 112.90254], [-7.81335, 112.90337], [-7.81367, 112.90254]] },
            { name: "Hutan Lestari Andari 01", color: "#ff5252", coords: [[-7.8151, 112.90525], [-7.81502, 112.9053], [-7.8151, 112.90525]] },
            { name: "Hutan Lestari Juman Tugu 02", color: "#ffea00", coords: [[-7.81609, 112.91223], [-7.81635, 112.91197], [-7.81609, 112.91223]] }
            // (Data dipersingkat, tetapi logika render akan berjalan)
        ];

        // --- 2. DATA UTAMA (DIKEMBALIKAN KE DATA LAMA 22.000 POHON) ---
        const local_data = {
            "tanam_2021": {
                id: "tanam_2021", year: 2021, location: "Program Konservasi Hutan Lindung",
                // KEMBALI KE ASAL: 5000 Pohon, 250 Rorak
                water_inputs: { tree: 5000, well: 10, biopore: 300, trench: 250, water_access: 0 },
                species: { "Alpukat": 105, "Nangka": 113, "Sukun": 67, "Lainnya": 70 },
                method: "old", 
                points: [[-7.822, 112.905, "Pohon"]], 
                areaPolygon: [MASTER_HUTAN_LINDUNG] 
            },
            "tanam_2022": {
                id: "tanam_2022", year: 2022, location: "Program Konservasi Tahun 2022",
                // KEMBALI KE ASAL: 10.000 Pohon, 750 Rorak
                water_inputs: { tree: 10000, well: 20, biopore: 300, trench: 750, water_access: 0 },
                species: { "Kopi Robusta": 9500, "Naungan": 500 },
                method: "old", 
                points: [[-7.814, 112.927, "Kopi"]], 
                areaPolygon: [MASTER_PETUNG] 
            },
            "tanam_2023": {
                id: "tanam_2023", year: 2023, location: "Program Konservasi AQUA Keboncandi 2023",
                // KEMBALI KE ASAL: 5.000 Pohon, 500 Rorak
                water_inputs: { tree: 5000, well: 5, biopore: 110, trench: 500, water_access: 0 },
                species: { "Kopi Robusta": 4000, "Naungan": 1000 },
                method: "old", 
                points: [[-7.822, 112.905, "Kopi"]], 
                areaPolygon: [] 
            },
            "tanam_2024": {
                id: "tanam_2024", year: 2024, location: "Program Konservasi Tahun 2024",
                // KEMBALI KE ASAL: 2.000 Pohon, 1.500 Rorak (Menggunakan data awal Anda)
                water_inputs: { tree: 2000, well: 1, biopore: 0, trench: 1500, water_access: 449.4 },
                species: { "Kopi Robusta": 1000, "Durian": 300, "Alpukat": 200 }, // Data awal
                method: "new", 
                points: [[-7.81636, 112.90502, "Rorak Supinto"]], 
                areaPolygon: DATA_2024_POLYGONS 
            }
        };

        // --- 3. LOGIKA PERHITUNGAN ---
        const SIPA_TARGET_MLY = 2996; 
        const VWB_CONST = 0.024953938;
        const RAIN_DAYS = 163;
        const F_INF = 3;

        // Volume Fisik (2021-2023)
        const VOL_WELL_OLD = 0.754; 
        const VOL_TRENCH_OLD = 0.490; 
        const VOL_BIO_OLD = 0.01; 

        // Konstanta Baru (2024)
        const CONST_TREE_2024 = 3750;
        const CONST_WELL_2024 = 1100000;
        const CONST_TRENCH_2024 = 170000;
        
        function calculateImpact(inputs, method) {
            let treeMLY = 0, wellMLY = 0, bioMLY = 0, trenchMLY = 0, accessMLY = 0;

            if (method === "old") {
                treeMLY = (inputs.tree / 400) * VWB_CONST * 31.536 * 0.75;
                wellMLY = inputs.well * (VOL_WELL_OLD * 1000) * F_INF * RAIN_DAYS / 1000000;
                bioMLY = inputs.biopore * (VOL_BIO_OLD * 1000) * F_INF * RAIN_DAYS / 1000000;
                trenchMLY = inputs.trench * (VOL_TRENCH_OLD * 1000) * F_INF * RAIN_DAYS / 1000000;
            } else {
                treeMLY = inputs.tree * CONST_TREE_2024 / 1000000;
                wellMLY = inputs.well * CONST_WELL_2024 / 1000000;
                trenchMLY = inputs.trench * CONST_TRENCH_2024 / 1000000;
                bioMLY = 0; 
            }

            accessMLY = inputs.water_access || 0;
            let totalMLY = treeMLY + wellMLY + bioMLY + trenchMLY + accessMLY;
            let totalLS = (totalMLY * 1000000) / 31536000;

            return { totalMLY, totalLS };
        }

        // --- 4. EKSEKUSI DATA ---
        Chart.register(ChartDataLabels);
        let totalT=0, totalR=0, totalReplenish=0;
        let years=[], dataTrees=[], dataRorak=[], dataSumur=[], dataBiopori=[];
        let dataBalance=[], dataPerformance=[];
        let speciesTotal={};

        const sortedKeys = Object.keys(local_data).sort(); 
        
        sortedKeys.forEach(key => {
            const item = local_data[key];
            const inp = item.water_inputs;
            
            totalT += inp.tree;
            totalR += inp.trench;
            
            let impact = calculateImpact(inp, item.method);
            totalReplenish += impact.totalMLY;

            years.push(item.year);
            dataTrees.push(inp.tree);
            dataRorak.push(inp.trench);
            dataSumur.push(inp.well);
            dataBiopori.push(inp.biopore);
            
            // Data untuk Chart Ganda
            dataBalance.push(impact.totalLS.toFixed(2));
            let perform = (impact.totalLS / 95 * 100).toFixed(1);
            dataPerformance.push(perform);

            if(item.species){
                for (const [sp, val] of Object.entries(item.species)) {
                    if(sp !== "Lainnya") speciesTotal[sp] = (speciesTotal[sp] || 0) + val;
                }
            }
        });

        // Update Text Stats
        document.getElementById('totalTrees').innerText = totalT.toLocaleString('id-ID');
        document.getElementById('totalRorak').innerText = totalR.toLocaleString('id-ID');
        document.getElementById('totalReplenish').innerText = totalReplenish.toLocaleString('id-ID', {maximumFractionDigits:0});

        // --- MAP RENDER (DIPERBAIKI DENGAN KOORDINAT LENGKAP) ---
        var map = L.map('map').setView([-7.810, 112.908], 13);
        L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);

        const iconTree = L.divIcon({html: '<div style="background:#2e7d32;width:8px;height:8px;border-radius:50%;border:1px solid white;"></div>'});
        const iconRorak = L.divIcon({html: '<div style="background:#ff9800;width:10px;height:10px;border-radius:50%;border:1px solid white;"></div>'});

        // 1. Gambar Master Background (Desa & Hutan Lindung)
        L.polygon(MASTER_DESA_GALIH, { color: 'gold', fillColor: 'transparent', weight: 2 }).bindPopup("Desa Galih").addTo(map);
        L.polygon(MASTER_PETUNG, { color: 'orange', fillColor: 'transparent', weight: 2 }).bindPopup("Desa Petung").addTo(map);
        L.polygon(MASTER_HUTAN_LINDUNG, { color: '#00e676', fillColor: '#00e676', fillOpacity: 0.1, weight: 1 }).bindPopup("Hutan Lindung").addTo(map);

        // 2. Gambar Detail Layer
        Object.values(local_data).forEach(item => {
            if (item.areaPolygon) {
                item.areaPolygon.forEach(poly => {
                    // Hanya gambar polygon warna-warni (Data 2024), jangan gambar ulang master
                    if (poly.coords && poly.color) {
                        L.polygon(poly.coords, { color: poly.color, fillColor: poly.color, fillOpacity: 0.6, weight: 2 }).bindPopup(poly.name).addTo(map);
                    }
                });
            }
            if(item.points){
                item.points.forEach(pt => {
                    let isRorak = pt[2].toLowerCase().includes("rorak");
                    L.marker([pt[0], pt[1]], {icon: isRorak ? iconRorak : iconTree}).addTo(map);
                });
            }
        });

        // --- CHARTS ---
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: years, datasets: [{ label: 'Pohon', data: dataTrees, backgroundColor: '#2e7d32', borderRadius:4 }] },
            options: { maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y: {beginAtZero: true} } }
        });

        new Chart(document.getElementById('chartRorak'), {
            type: 'bar',
            data: { labels: years, datasets: [{ label: 'Rorak', data: dataRorak, backgroundColor: '#795548', borderRadius:4 }] },
            options: { maintainAspectRatio: false, plugins: { legend:{display:false} } }
        });

        new Chart(document.getElementById('chartSumur'), {
            type: 'bar',
            data: { labels: years, datasets: [{ label: 'Sumur Resapan', data: dataSumur, backgroundColor: '#0277bd', borderRadius:4 }, { label: 'Biopori', data: dataBiopori, backgroundColor: '#4fc3f7', borderRadius:4 } ] },
            options: { maintainAspectRatio: false, plugins: { legend:{position:'bottom'} }, scales:{x:{stacked:false}, y:{beginAtZero:true}} }
        });

        const sortedSpecies = Object.entries(speciesTotal).sort((a,b) => b[1] - a[1]);
        const topSpecies = sortedSpecies.slice(0, 5);
        let pieLabels = topSpecies.map(x => x[0]);
        let pieData = topSpecies.map(x => x[1]);

        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#1b5e20', '#2e7d32', '#43a047', '#66bb6a', '#81c784'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // --- NEW DOUBLE BAR CHART (BALANCE & PERFORMANCE) ---
        new Chart(document.getElementById('wbChart'), {
            type: 'bar',
            data: {
                labels: years,
                datasets: [
                    { 
                        label: 'Balance (L/s)', 
                        data: dataBalance, 
                        backgroundColor: '#d32f2f', // Merah
                        borderRadius: 4
                    },
                    { 
                        label: 'Performance (%)', 
                        data: dataPerformance, 
                        backgroundColor: '#fbc02d', // Kuning
                        borderRadius: 4
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Nilai' }
                    }
                }
            }
        });

        // --- TABLE ---
        const tbody = document.getElementById('tableBody');
        sortedKeys.reverse().forEach(key => {
            const item = local_data[key];
            const inp = item.water_inputs;
            const impact = calculateImpact(inp, item.method);
            const performance = (impact.totalLS / 95 * 100).toFixed(1);

            tbody.innerHTML += `
            <tr>
                <td class="ps-4 fw-bold">${item.year}</td>
                <td>${item.location}</td>
                <td class="text-center">${inp.tree.toLocaleString()}</td>
                <td class="text-center">${inp.trench.toLocaleString()}</td>
                <td class="text-center">${inp.well.toLocaleString()}</td>
                <td class="text-center">${inp.biopore.toLocaleString()}</td>
                <td class="text-end pe-4">
                    <div class="fw-bold text-dark">${impact.totalMLY.toFixed(1)} <small class="text-muted fw-normal">ML/Y</small></div>
                    <div class="replenish-box mt-1">
                        <div class="d-flex justify-content-between mb-1 border-bottom pb-1">
                            <span class="replenish-label">Balance</span>
                            <span class="replenish-val text-danger">${impact.totalLS.toFixed(2)} <small>L/s</small></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="replenish-label">Perform.</span>
                            <span class="replenish-val text-warning">${performance}%</span>
                        </div>
                    </div>
                </td>
                <td><button class="btn btn-sm btn-outline-secondary px-3" onclick="window.location.href='planting_detail.html?id=${key}'">Detail</button></td>
            </tr>`;
        });
    </script>
</body>
</html>
