<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sebaran Penanaman - SIS KEHATI</title>
    
    <!-- Library -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        /* TEMA DARK MODE */
        body { font-family: 'Montserrat', sans-serif; background-color: #050505; color: #eee; padding-bottom: 50px; }
        
        /* --- 1. HEADER KHUSUS (BACKGROUND HUTAN) --- */
        .top-hero-wrapper {
            position: relative;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.9)), url('hutan-bg.jpg') no-repeat center center/cover;
            padding-bottom: 20px;
            margin-bottom: 30px;
            border-bottom: 4px solid #c6ff00;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
        }

        .header-bar { padding: 15px 0; margin-bottom: 10px; }
        .logo-img { height: 45px; margin-right: 15px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        
        /* TOMBOL KEMBALI (NEON) */
        .btn-unified {
            background-color: #c6ff00; 
            color: #000; 
            font-weight: 800;
            border: none;
            border-radius: 50px;
            padding: 8px 25px;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .btn-unified:hover { background-color: #ffffff; color: #000; transform: translateY(-2px); }

        /* JUDUL HALAMAN */
        .page-title-area { text-align: center; }
        .page-title-main {
            font-weight: 800;
            font-size: 1.8rem;
            color: #c6ff00; 
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
            text-shadow: 0 0 15px rgba(198, 255, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; 
        }
        .page-title-sub {
            color: #ffffff; 
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- STATS CARD (DARK MODE) --- */
        .stat-card { 
            background: #121212;
            border: 1px solid #333;
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            min-height: 140px; 
            position:relative; 
            overflow:hidden; 
        }
        /* Aksen Warna Border Kiri */
        .border-left-green { border-left: 5px solid #2e7d32; }
        .border-left-brown { border-left: 5px solid #795548; }
        .border-left-blue { border-left: 5px solid #0277bd; }

        .stat-header { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 2.5rem; font-weight: 800; line-height: 1; margin: 10px 0; color: white; }
        .stat-icon { position: absolute; right: 20px; bottom: 20px; font-size: 3rem; opacity: 0.1; color: white; }

        /* --- CARD CUSTOM --- */
        .card-custom { 
            border: 1px solid #333; 
            border-radius: 12px; 
            background: #121212; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            margin-bottom: 20px; 
            overflow: hidden; 
        }
        
        /* HEADER KOTAK (NEON) */
        .card-header-unified { 
            background: #c6ff00; 
            padding: 10px 20px; 
            border-bottom: 1px solid #aeea00; 
            font-weight: 800; 
            color: #000; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        /* MAP STYLE */
        #map { height: 350px; width: 100%; z-index: 1; background: #222; }
        .map-photo { 
            height: 350px; width: 100%; 
            object-fit: cover; 
            display: block;
            border-left: 1px solid #333;
        }
        
        /* FOOTER PETA */
        .map-footer-strip {
            background-color: #121212;
            padding: 12px 0;
            text-align: center;
            border-top: 3px solid #c6ff00;
            width: 100%;
        }
        
        /* CHART WRAPPER */
        .chart-wrapper { position: relative; width: 100%; height: 300px; padding: 10px; }

        /* TABEL STYLE (PUTIH) */
        .table-visible { width: 100%; margin-bottom: 0; background-color: white; }
        .table-visible th {
            background-color: #f1f1f1;
            color: #000;
            font-weight: 700;
            padding: 12px;
            border-bottom: 2px solid #ccc;
            font-size: 0.85rem;
        }
        .table-visible td {
            padding: 10px 12px;
            vertical-align: middle;
            color: #000000 !important; 
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .table-visible tr:hover { background-color: #f9f9f9; }

        .btn-detail { border: 1px solid #aaa; color: #555; background: white; padding: 4px 12px; font-size: 0.75rem; border-radius: 4px; text-decoration: none; }
        .btn-detail:hover { background: #333; color: white; }

        /* BADGE INFO (Footer Map) */
        .badge-info-item {
            background: #1a1a1a; padding: 5px 20px; border-radius: 6px;
            font-size: 0.8rem; font-weight: 700; margin: 0 5px;
            display: inline-flex; align-items: center; border: 2px solid;
        }
        .style-pohon { border-color: #2e7d32; color: #4caf50; }
        .style-rorak { border-color: #795548; color: #a1887f; }
        .style-sumur { border-color: #0277bd; color: #03a9f4; }

    </style>
</head>
<body>

    <!-- 1. HEADER (BACKGROUND HUTAN) -->
    <div class="top-hero-wrapper">
        <div class="header-bar">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="logo-sk.png" class="logo-img" onerror="this.style.display='none'">
                    <div class="text-white" style="line-height: 1.2;">
                        <div class="fw-bold fs-5">SEKOLA KONANG</div>
                        <div style="font-weight:400; font-size:0.8rem; letter-spacing: 1px; color:#c6ff00;">INDONESIA</div>
                    </div>
                </div>
                <a href="menu.html" class="btn-unified"><i class="fas fa-arrow-left me-2"></i> Kembali ke Menu</a>
            </div>
        </div>

        <div class="page-title-area">
            <div class="page-title-main">
                <i class="fas fa-tree"></i> 
                SEBARAN PENANAMAN & KONSERVASI
            </div>
            <div class="page-title-sub">MONITORING REBOISASI DAN SIPIL TEKNIS</div>
        </div>
    </div>

    <div class="container-fluid px-4">
        
        <!-- ROW 1: TOP STATS (DARK CARD) -->
        <div class="row mb-4">
            <div class="col-md-4 mb-2">
                <div class="stat-card border-left-green">
                    <div class="stat-header text-success">Total Pohon</div>
                    <div class="stat-val" id="totalTrees">0</div>
                    <small class="text-secondary">Akumulasi Realisasi Tanam</small>
                    <i class="fas fa-tree stat-icon"></i>
                </div>
            </div>
            <div class="col-md-4 mb-2">
                <div class="stat-card border-left-brown">
                    <div class="stat-header" style="color: #a1887f;">Total Rorak</div>
                    <div class="stat-val" id="totalRorak">0</div>
                    <small class="text-secondary">Unit Sipil Teknis Terbangun</small>
                    <i class="fas fa-inbox stat-icon"></i>
                </div>
            </div>
            <div class="col-md-4 mb-2">
                <div class="stat-card border-left-blue">
                    <div class="stat-header text-info">Total Infiltrasi</div>
                    <div class="stat-val" id="totalReplenish">0</div>
                    <small class="text-secondary">ML/Year (Hasil Kalkulasi)</small>
                    <i class="fas fa-water stat-icon"></i>
                </div>
            </div>
        </div>

        <!-- ROW 2: PETA & GAMBAR (LAYOUT GRID) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom">
                    <!-- HEADER NEON -->
                    <div class="card-header-unified">
                        <span><i class="fas fa-map-marked-alt me-2"></i> Peta Sebaran & Delineasi Area</span>
                        <span class="badge bg-dark text-white border border-light"><i class="fas fa-satellite me-1"></i> Google Hybrid</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <!-- PETA (8 KOLOM) -->
                            <div class="col-lg-8">
                                <div id="map"></div>
                            </div>
                            <!-- GAMBAR (4 KOLOM) -->
                            <div class="col-lg-4 d-none d-lg-block">
                                <img src="https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop" class="map-photo" alt="Hutan">
                            </div>
                        </div>
                        <!-- FOOTER -->
                        <div class="map-footer-strip">
                            <div style="font-weight:800; color:#c6ff00; margin-bottom:5px;">ZONA KONSERVASI HUTAN</div>
                            <small class="text-secondary d-block mb-2">Visualisasi sebaran penanaman pohon dan pembuatan rorak/sumur resapan.</small>
                            <div class="d-flex justify-content-center gap-3">
                                <span class="badge-info-item style-pohon"><i class="fas fa-tree me-2"></i> Pohon</span>
                                <span class="badge-info-item style-rorak"><i class="fas fa-inbox me-2"></i> Rorak</span>
                                <span class="badge-info-item style-sumur"><i class="fas fa-water me-2"></i> Sumur</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: GRAFIK (CARD DARK) -->
        <div class="row mb-4">
            <!-- Grafik Pohon & Pie Chart -->
            <div class="col-lg-8 mb-3">
                <div class="card card-custom">
                    <div class="card-header-unified">
                        <span><i class="fas fa-chart-bar me-2"></i> Realisasi Penanaman Pohon</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card card-custom h-100">
                    <div class="card-header-unified">
                        <span><i class="fas fa-chart-pie me-2"></i> Komposisi Tanaman</span>
                    </div>
                    <div class="card-body d-flex align-items-center">
                        <div class="chart-wrapper" style="height: 250px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 4: GRAFIK SIPIL TEKNIS & AIR -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card card-custom">
                    <div class="card-header-unified">
                        <span><i class="fas fa-inbox me-2"></i> Pembuatan Rorak & Sumur</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <canvas id="chartRorakSumur"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card card-custom">
                    <div class="card-header-unified">
                        <span><i class="fas fa-tint me-2"></i> Replenished Water vs SIPA</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-wrapper">
                            <canvas id="wbChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 5: TABEL HISTORY (PUTIH) -->
        <div class="card card-custom mb-5">
            <div class="card-header-unified">
                <span><i class="fas fa-list me-2"></i> Riwayat Program</span>
            </div>
            <div class="table-responsive">
                <table class="table table-visible">
                    <thead>
                        <tr>
                            <th class="ps-4">Tahun</th>
                            <th>Program / Lokasi</th>
                            <th class="text-center">Pohon</th>
                            <th class="text-center">Rorak</th>
                            <th class="text-center">Sumur</th>
                            <th class="text-center">Biopori</th>
                            <th class="text-end pe-4" style="min-width: 150px;">Infiltrasi (ML/Y)</th>
                            <th class="text-end pe-4">Balance (L/s)</th>
                            <th class="text-end pe-4">Perf. (%)</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script src="database_planting.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- 1. KONFIGURASI RUMUS (SAMA SEPERTI SEBELUMNYA) ---
        const SIPA_LS = 95.00;        
        const SIPA_MLY = 2996;        
        const TIME_FACTOR = 31.536;   
        const VWB_CONST = 0.024953938;
        const VOL_SUMUR_NEW = 754; 
        const VOL_RORAK_NEW = 490;
        const RAIN_DAYS = 163;

        const KONSTANTA_2024 = { rorak: 0.17, sumur: 1.1, pohon_per_ha: 1.5, kerapatan_pohon: 400 };

        function calculateWater(year, stats) {
            let res = 0;
            if (year === 2024) {
                let t = (stats.trees / 400) * 1.5;
                let s = stats.sumur * 1.1;
                let r = stats.rorak * 0.17;
                res = t + s + r;
            } else {
                let t = (stats.trees / 400) * VWB_CONST * TIME_FACTOR * 0.75;
                let s = (stats.sumur * VOL_SUMUR_NEW * 3 * RAIN_DAYS) / 1000000;
                let r = (stats.rorak * VOL_RORAK_NEW * 3 * RAIN_DAYS) / 1000000;
                let b = (stats.biopori / 300) * 1.5;
                res = t + s + r + b;
            }
            return res;
        }

        // --- 2. PROSES DATA ---
        Chart.register(ChartDataLabels);
        Chart.defaults.color = '#ffffff'; // Default text color for charts -> White
        Chart.defaults.borderColor = '#333'; // Default grid line color

        let totalT = 0, totalR = 0, totalInfiltrasiKumulatif = 0;
        let years = [], dataTrees = [], dataRorak = [], dataSumur = [], dataReplenished = [], dataBalance = [], dataPerformance = [];
        let speciesTotal = {};

        const dbKeys = Object.keys(db_planting.years).sort();

        dbKeys.forEach(key => {
            const item = db_planting.years[key];
            const s = item.stats;
            const year = item.year;

            totalT += s.trees;
            totalR += s.rorak;

            let currentInfiltrasi = calculateWater(year, s);
            totalInfiltrasiKumulatif += currentInfiltrasi;

            let valBalance = currentInfiltrasi / TIME_FACTOR;
            let valPerformance = (valBalance / SIPA_LS) * 100;

            years.push(year);
            dataTrees.push(s.trees);
            dataRorak.push(s.rorak);
            dataSumur.push(s.sumur + s.biopori); // Gabung sumur & biopori untuk grafik ringkas
            dataReplenished.push(currentInfiltrasi);
            dataBalance.push(valBalance);
            dataPerformance.push(valPerformance);

            if(item.species) {
                for (const [sp, val] of Object.entries(item.species)) {
                    speciesTotal[sp] = (speciesTotal[sp] || 0) + val;
                }
            }
        });

        document.getElementById('totalTrees').innerText = totalT.toLocaleString('id-ID');
        document.getElementById('totalRorak').innerText = totalR.toLocaleString('id-ID');
        document.getElementById('totalReplenish').innerText = totalInfiltrasiKumulatif.toLocaleString('id-ID', {maximumFractionDigits:0});

        // --- 3. PETA ---
        var map = L.map('map', {zoomControl: false}).setView([-7.810, 112.908], 13);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);

        const iconTree = L.divIcon({html: '<div style="background:#2e7d32;width:8px;height:8px;border-radius:50%;border:1px solid white;"></div>'});
        const iconRorak = L.divIcon({html: '<div style="background:#ff9800;width:10px;height:10px;border-radius:50%;border:1px solid white;"></div>'});
        var allFeatureGroup = L.featureGroup();

        dbKeys.forEach(key => {
            const item = db_planting.years[key];
            if (item.areaPolygon) {
                item.areaPolygon.forEach(poly => {
                    if (poly.coords && poly.color) {
                        allFeatureGroup.addLayer(L.polygon(poly.coords, { color: poly.color, fillColor: poly.color, fillOpacity: 0.5, weight: 1 }).bindPopup(`<b>${poly.name}</b><br>${item.year}`));
                    } else {
                        allFeatureGroup.addLayer(L.polygon(poly, { color: '#c6ff00', fillColor: 'transparent', weight: 2, dashArray: '5, 5', opacity: 0.7 }).bindPopup(`Area Master (${item.year})`));
                    }
                });
            }
            if (item.points) {
                item.points.forEach(pt => {
                    let desc = pt[2] || "";
                    let isRorak = desc.toLowerCase().includes("rorak");
                    allFeatureGroup.addLayer(L.marker([pt[0], pt[1]], {icon: isRorak ? iconRorak : iconTree}).bindPopup(`${desc}<br>Tahun: ${item.year}`));
                });
            }
        });

        allFeatureGroup.addTo(map);
        if (allFeatureGroup.getLayers().length > 0) map.fitBounds(allFeatureGroup.getBounds(), {padding: [50, 50]});

        // --- 4. GRAFIK (LABEL PUTIH) ---
        const whiteLabel = { color: '#ffffff', font: { weight: 'bold' }, anchor: 'center', align: 'center' };

        // Chart Pohon
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: years, datasets: [{ label: 'Pohon', data: dataTrees, backgroundColor: '#2e7d32', borderRadius:4 }] },
            options: { maintainAspectRatio: false, plugins: { legend: {display:false}, datalabels: whiteLabel }, scales: { y: {beginAtZero: true} } }
        });

        // Chart Pie
        const topSpecies = Object.entries(speciesTotal).sort((a,b) => b[1] - a[1]).slice(0, 5);
        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels: topSpecies.map(x=>x[0]), datasets: [{ data: topSpecies.map(x=>x[1]), backgroundColor: ['#1b5e20', '#2e7d32', '#43a047', '#66bb6a', '#81c784'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position:'right', labels: {color:'white'} }, datalabels: { color: '#fff' } } }
        });

        // Chart Rorak & Sumur (Gabung)
        new Chart(document.getElementById('chartRorakSumur'), {
            type: 'bar',
            data: { labels: years, datasets: [
                { label: 'Rorak', data: dataRorak, backgroundColor: '#795548', borderRadius:4 },
                { label: 'Sumur & Biopori', data: dataSumur, backgroundColor: '#0277bd', borderRadius:4 }
            ]},
            options: { maintainAspectRatio: false, plugins: { legend:{labels:{color:'white'}}, datalabels: whiteLabel }, scales: { y: {beginAtZero: true} } }
        });

        // Chart Air
        new Chart(document.getElementById('wbChart'), {
            type: 'bar',
            data: {
                labels: years,
                datasets: [
                    { type: 'line', label: 'Batas SIPA (ML/Y)', data: Array(years.length).fill(SIPA_MLY), borderColor: '#d32f2f', borderDash: [5, 5], pointRadius: 0, datalabels: { display: false } },
                    { label: 'Infiltrasi (ML/Y)', data: dataReplenished, backgroundColor: '#03a9f4', borderRadius: 4 }
                ]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { labels:{color:'white'}, position: 'bottom' }, datalabels: { anchor: 'end', align: 'top', color: '#fff', formatter: Math.round } }, scales: { y: { beginAtZero: true } } }
        });

        // --- 5. TABEL (PUTIH) ---
        const tbody = document.getElementById('tableBody');
        let reversedKeys = [...dbKeys].reverse();

        reversedKeys.forEach(key => {
            const item = db_planting.years[key];
            const s = item.stats;
            const year = item.year;
            
            let mly = calculateWater(year, s);
            let blc = mly / TIME_FACTOR;
            let prf = (blc / SIPA_LS) * 100;

            tbody.innerHTML += `
            <tr>
                <td class="ps-4 fw-bold text-dark">${year}</td>
                <td class="text-dark">${item.location}</td>
                <td class="text-center text-dark">${s.trees.toLocaleString()}</td>
                <td class="text-center text-dark">${s.rorak.toLocaleString()}</td>
                <td class="text-center text-dark">${s.sumur.toLocaleString()}</td>
                <td class="text-center text-dark">${s.biopori.toLocaleString()}</td>
                <td class="text-end pe-4 fw-bold text-primary">${mly.toLocaleString(undefined, {minimumFractionDigits:1, maximumFractionDigits:1})}</td>
                <td class="text-end pe-4 text-danger fw-bold">${blc.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td class="text-end pe-4 text-success fw-bold">${prf.toLocaleString(undefined, {minimumFractionDigits:1, maximumFractionDigits:1})}%</td>
                <td><button class="btn btn-detail" onclick="window.location.href='planting_detail.html?id=${key}'">Detail</button></td>
            </tr>`;
        });
    </script>
</body>
</html>
