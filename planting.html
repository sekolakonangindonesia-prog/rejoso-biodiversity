<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sebaran Penanaman - SIS KEHATI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding-bottom: 50px; }
        .navbar-custom { background: linear-gradient(to right, #1b5e20, #2e7d32); padding: 15px 0; }
        .btn-home { color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 50px; padding: 5px 15px; text-decoration: none; }
        .stat-card { color: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .stat-val { font-size: 2.5rem; font-weight: 800; }
        .bg-tree { background: #2e7d32; } .bg-rorak { background: #5d4037; } .bg-sumur { background: #0277bd; }
        .card-custom { border: none; border-radius: 10px; background: white; margin-bottom: 20px; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #map { height: 450px; width: 100%; border-radius: 10px; }
        .chart-wrapper { height: 250px; width: 100%; }
        .table-hover tbody tr:hover { background-color: #e8f5e9; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar navbar-custom sticky-top">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-seedling fa-lg text-white me-3"></i><span class="text-white fw-bold fs-4">DASHBOARD PENANAMAN</span>
            </div>
            <a href="index.html" class="btn-home"><i class="fas fa-arrow-left me-2"></i>Home</a>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4">
        <!-- STATS -->
        <div class="row mb-4">
            <div class="col-md-4 mb-2"><div class="stat-card bg-tree"><div class="stat-val" id="totalTrees">0</div><small>Total Pohon</small><i class="fas fa-tree fa-3x position-absolute end-0 bottom-0 m-3 opacity-25"></i></div></div>
            <div class="col-md-4 mb-2"><div class="stat-card bg-rorak"><div class="stat-val" id="totalRorak">0</div><small>Total Rorak</small><i class="fas fa-inbox fa-3x position-absolute end-0 bottom-0 m-3 opacity-25"></i></div></div>
            <div class="col-md-4 mb-2"><div class="stat-card bg-sumur"><div class="stat-val" id="totalSumur">0</div><small>Sumur Resapan</small><i class="fas fa-water fa-3x position-absolute end-0 bottom-0 m-3 opacity-25"></i></div></div>
        </div>

        <!-- PETA & GRAFIK -->
        <div class="row mb-4">
            <div class="col-lg-8"><div class="card card-custom p-0"><div class="card-body p-0"><div id="map"></div></div></div></div>
            <div class="col-lg-4">
                <div class="card card-custom mb-3"><div class="card-body"><h6 class="fw-bold text-center">Realisasi Tahunan</h6><div class="chart-wrapper"><canvas id="barChart"></canvas></div></div></div>
                <div class="card card-custom"><div class="card-body"><h6 class="fw-bold text-center">Jenis Tanaman</h6><div class="chart-wrapper"><canvas id="pieChart"></canvas></div></div></div>
            </div>
        </div>

        <!-- TABEL -->
        <div class="card card-custom">
            <div class="card-header bg-white fw-bold"><i class="fas fa-list me-2"></i> Riwayat Penanaman (Klik untuk Detail)</div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-4">Tahun</th><th>Lokasi</th><th>Pohon</th><th>Rorak</th><th>Sumur</th><th>Aksi</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="database_planting.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        Chart.register(ChartDataLabels);
        let totalT = 0, totalR = 0, totalS = 0;
        let years = [], dTrees = [], dRorak = [], dSumur = [];
        let speciesCount = {};

        const sortedKeys = Object.keys(db_planting.years).sort().reverse();
        sortedKeys.forEach(key => {
            const item = db_planting.years[key];
            totalT += item.stats.trees; totalR += item.stats.rorak; totalS += item.stats.sumur;
            years.push(item.year); dTrees.push(item.stats.trees); dRorak.push(item.stats.rorak); dSumur.push(item.stats.sumur);
            for(const [sp, c] of Object.entries(item.species)) speciesCount[sp] = (speciesCount[sp]||0)+c;
        });

        document.getElementById('totalTrees').innerText = totalT.toLocaleString();
        document.getElementById('totalRorak').innerText = totalR.toLocaleString();
        document.getElementById('totalSumur').innerText = totalS.toLocaleString();

        var map = L.map('map').setView([-7.723, 112.932], 12);
        L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', { maxZoom: 20 }).addTo(map);

        const treeIcon = L.divIcon({html:'<div style="background:#2e7d32;width:10px;height:10px;border-radius:50%;border:1px solid white;"></div>'});

        Object.values(db_planting.years).forEach(item => {
            item.points.forEach(pt => {
                L.marker([pt[0], pt[1]], {icon: treeIcon}).addTo(map).bindPopup(`<b>${item.year}</b><br>${item.location}`);
            });
        });

        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: years.reverse(), datasets: [{label:'Pohon', data:dTrees.reverse(), backgroundColor:'#2e7d32'}, {label:'Rorak', data:dRorak.reverse(), backgroundColor:'#5d4037'}] },
            options: { maintainAspectRatio: false, plugins: {legend:{position:'bottom'}, datalabels:{color:'white', font:{size:9}}}, scales:{x:{stacked:true}, y:{stacked:true}} }
        });

        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels: Object.keys(speciesCount), datasets: [{data: Object.values(speciesCount), backgroundColor: ['#1b5e20','#2e7d32','#43a047','#66bb6a','#81c784']}] },
            options: { maintainAspectRatio: false, plugins: {legend:{position:'right', labels:{boxWidth:10}}, datalabels:{display:false}} }
        });

        const tbody = document.getElementById('tableBody');
        sortedKeys.forEach(key => {
            const i = db_planting.years[key];
            tbody.innerHTML += `<tr onclick="window.location.href='planting_detail.html?id=${key}'"><td class="ps-4 fw-bold">${i.year}</td><td>${i.location}</td><td><span class="badge bg-success">${i.stats.trees}</span></td><td>${i.stats.rorak}</td><td>${i.stats.sumur}</td><td><button class="btn btn-sm btn-outline-secondary">Detail</button></td></tr>`;
        });
    </script>
</body>
</html>
